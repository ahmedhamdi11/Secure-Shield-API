from keras.models import load_model
from flask_restful import Resource, reqparse
from werkzeug.datastructures import FileStorage
import pandas as pd

# load the h5 model
malwareDetectionModel = load_model('ai_models/cnn_malware-executable-detection.h5')

# arguments
post_args = reqparse.RequestParser()
post_args.add_argument('file',
                        type =FileStorage,
                          help='file.csv is required',
                            required=True,
                            location ='files')


# preprocess the file 
def preprocessFile(file):

    df =pd.read_csv(file)

    return df

class MalwareDetection(Resource):
    def post(self):
        args =post_args.parse_args()

        # preprocess the email content 
        preprocessedFile = preprocessFile(args['file'])

        # Make predictions
        pred_prob = malwareDetectionModel.predict(preprocessedFile)
        pred = (pred_prob > 0.5).astype(int)  

        predicted_label = "Safe" if pred[0][0] == 1 else "Malicious"
        prediction_accuracy ='{:.2f}%'.format(float(pred_prob[0][0]) *100) if pred[0][0] == 1 else '{:.2f}%'.format(100- float(pred_prob[0][0]) *100)
        prediction_details = {
            'prediction': predicted_label,
            'prediction_accuracy': prediction_accuracy,
        }

        return {'data':prediction_details}
